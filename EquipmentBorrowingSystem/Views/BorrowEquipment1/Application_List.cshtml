@model IEnumerable<EquipmentBorrowingSystem.Models.Application_Details>
@using System.Text
@{
    ViewBag.Title = "申請清單";
    Layout = "~/Views/Shared/_Layout_Member.cshtml";

    int equipmentCount = Model.Count(m => m.Is_Consumable == "False");
    int consumableCount = 0;
    foreach (var item in Model.Where(m => m.Is_Consumable == "True"))
    {
        consumableCount += int.Parse(item.Consumable_Borrowing_Times);
    }
    bool isEmpty = !Model.Any();

    // 產生 Email 驗證碼（6碼英數）
    string Email_Verification_Code()
    {
        Random random = new Random();
        char[] letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0".ToCharArray();
        char[] digits  = "123456789".ToCharArray();
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 6; i++)
        {
            if (random.Next(1, 3) == 1)
                sb.Append(digits[random.Next(digits.Length)]);
            else
                sb.Append(letters[random.Next(letters.Length)]);
        }
        return sb.ToString();
    }
}

<div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
        <h4><i class="bi bi-cart3 me-2" style="color:#5b9bd5;"></i>設備借用申請清單</h4>
        <p class="page-subtitle">確認清單後，填寫申請資料並提出借用申請</p>
    </div>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showAdminListModal()">
        <i class="bi bi-shield-lock me-1"></i>管理者模式
    </button>
</div>

@* ===== 申請清單概覽 ===== *@
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card stat-primary">
            <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
            <div>
                <div class="stat-number">@equipmentCount</div>
                <div class="stat-label">一般設備</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card stat-warning">
            <div class="stat-icon"><i class="bi bi-stack"></i></div>
            <div>
                <div class="stat-number" id="consumables-count">@consumableCount</div>
                <div class="stat-label">消耗品數量</div>
            </div>
        </div>
    </div>
</div>

@if (isEmpty)
{
    <div class="content-card mb-4">
        <div class="content-card-body text-center py-5">
            <i class="bi bi-cart-x text-muted" style="font-size:3rem;"></i>
            <p class="text-muted mt-3 mb-1">申請清單是空的</p>
            <a href="@Url.Action("Browse_equipment", "BorrowEquipment1")" class="btn btn-accent btn-sm mt-2">
                <i class="bi bi-search me-1"></i>去瀏覽設備
            </a>
        </div>
    </div>
}
else
{
    @* ===== 一般設備清單 ===== *@
    <div class="content-card mb-3">
        <div class="content-card-header">
            <h5><i class="bi bi-box-seam"></i> 一般設備</h5>
        </div>
        @if (!Model.Any(m => m.Is_Consumable == "False"))
        {
            <div class="content-card-body text-muted small">（無一般設備）</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-custom mb-0">
                    <thead>
                        <tr>
                            <th style="width:35%">設備名稱</th>
                            <th style="width:25%">設備型號</th>
                            <th style="width:12%">設備編號</th>
                            <th style="width:15%">設備來源</th>
                            <th style="width:13%">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Where(m => m.Is_Consumable == "False"))
                        {
                            <tr>
                                <td class="fw-semibold">@item.EName</td>
                                <td class="text-muted small">@item.Emodel</td>
                                <td>
                                    <span class="badge rounded-pill" style="background:rgba(91,155,213,0.12);color:#2d6fa3;">@item.EId</span>
                                </td>
                                <td class="text-muted small">@item.ESource</td>
                                <td>
                                    <form action="@Url.Action("Delete_Application_Details", "BorrowEquipment1")" method="post">
                                        <input type="hidden" name="fId" value="@item.fId" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                                onclick="return confirm('確定要移除此設備嗎？')" style="font-size:.75rem;">
                                            <i class="bi bi-trash3 me-1"></i>移除
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    @* ===== 消耗品清單 ===== *@
    @if (Model.Any(m => m.Is_Consumable == "True"))
    {
        <div class="content-card mb-3">
            <div class="content-card-header">
                <h5><i class="bi bi-stack"></i> 消耗品</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-custom mb-0">
                    <thead>
                        <tr>
                            <th style="width:35%">消耗品名稱</th>
                            <th style="width:25%">型號</th>
                            <th style="width:15%">借用數量</th>
                            <th style="width:12%">來源</th>
                            <th style="width:13%">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Where(m => m.Is_Consumable == "True"))
                        {
                            <tr>
                                <td class="fw-semibold">@item.EName</td>
                                <td class="text-muted small">@item.Emodel</td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0"
                                                onclick="changeValue('decrease','consumable_@(item.EName)@(item.Emodel)','@item.EName','@item.Emodel','@item.fOrderGuid')">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        @Html.TextBoxFor(m => item.Consumable_Borrowing_Times, new
                                        {
                                            @class = "form-control form-control-sm text-center",
                                            type = "number",
                                            @readonly = "readonly",
                                            id = "consumable_" + item.EName + item.Emodel,
                                            style = "width:55px;"
                                        })
                                        <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0"
                                                onclick="changeValue('increase','consumable_@(item.EName)@(item.Emodel)','@item.EName','@item.Emodel','@item.fOrderGuid')">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="text-muted small">@item.ESource</td>
                                <td>
                                    <form action="@Url.Action("Delete_Application_Details", "BorrowEquipment1")" method="post">
                                        <input type="hidden" name="fId" value="@item.fId" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                                onclick="return confirm('確定要移除此消耗品嗎？')" style="font-size:.75rem;">
                                            <i class="bi bi-trash3 me-1"></i>移除
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @* ===== 申請表單 ===== *@
    <div class="content-card">
        <div class="content-card-header">
            <h5><i class="bi bi-person-lines-fill"></i> 填寫申請資料</h5>
        </div>
        <div class="content-card-body">
            <form action="@Url.Action("Application_List", "BorrowEquipment1")" method="post"
                  onsubmit="return validateForm()">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold small">申請人姓名 <span class="text-danger">*</span></label>
                        <input type="text" id="Name" name="Name" required autocomplete="off"
                               class="form-control form-control-sm" placeholder="請輸入姓名" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold small">申請人聯絡電話 <span class="text-danger">*</span></label>
                        <input type="tel" id="Mobile" name="Mobile" required autocomplete="off"
                               pattern="09[0-9]{8}" title="請輸入有效的電話號碼（10位數字，以09開頭）"
                               class="form-control form-control-sm" placeholder="09XXXXXXXX" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold small">借用時間 <span class="text-danger">*</span></label>
                        <input type="datetime-local" id="Borrow_Time" name="Borrow_Time" required
                               min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                               class="form-control form-control-sm" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold small">歸還時間 <span class="text-danger">*</span></label>
                        <input type="datetime-local" id="Return_Time" name="Return_Time" required
                               min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                               class="form-control form-control-sm" />
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-semibold small">
                            申請人信箱（需驗證）<span class="text-danger">*</span>
                        </label>
                        <div class="input-group input-group-sm">
                            <input type="email" id="email" name="fEmail" required autocomplete="off"
                                   class="form-control" placeholder="example@email.com"
                                   pattern="[a-zA-Z0-9._%+\-]+@@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}" />
                            <button type="button" id="sendButton" class="btn btn-outline-secondary"
                                    onclick="sendEmailVerificationCode()">
                                <i class="bi bi-envelope me-1"></i>發送驗證碼
                            </button>
                        </div>
                        <div id="emailVerifiedMsg" class="text-success small mt-1" style="display:none;">
                            <i class="bi bi-check-circle-fill me-1"></i>Email 驗證成功
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-semibold small">用途說明 <span class="text-danger">*</span></label>
                        <input type="text" id="Illustrate" name="Illustrate" required autocomplete="off"
                               class="form-control form-control-sm" placeholder="請說明借用用途" />
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-accent px-4">
                            <i class="bi bi-send-fill me-2"></i>提出借用申請
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
}

@* ===== 管理者模式 Modal ===== *@
<div class="modal fade" id="adminListModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content" style="border-radius:12px;overflow:hidden;">
            <div class="modal-body text-center pt-4 pb-3 px-4">
                <div class="mb-3" style="width:52px;height:52px;border-radius:50%;background:rgba(44,48,53,0.1);display:flex;align-items:center;justify-content:center;margin:0 auto;font-size:1.4rem;color:#2c3035;">
                    <i class="bi bi-shield-lock"></i>
                </div>
                <h6 class="fw-bold mb-1">管理者驗證</h6>
                <p class="text-muted small mb-3">請輸入管理權限密碼</p>
                <div id="adminListError" class="alert alert-danger py-2 small d-none mb-2">密碼輸入錯誤</div>
                <input type="password" id="adminListPwd" class="form-control form-control-sm text-center mb-3"
                       placeholder="請輸入密碼" autocomplete="off" />
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-light btn-sm flex-fill" data-bs-dismiss="modal">取消</button>
                    <button type="button" id="adminListConfirmBtn" class="btn btn-sm flex-fill text-white"
                            style="background-color:#2c3035;" onclick="validateAdminListPassword()">確認</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    var applicationConsumablesCount = @consumableCount;

    // ===== 申請表單驗證 =====
    function validateForm() {
        var bt = new Date(document.getElementById("Borrow_Time").value);
        var rt = new Date(document.getElementById("Return_Time").value);
        if (rt < bt) { alert("歸還時間不能早於借用時間"); return false; }
        if (@equipmentCount == 0 && applicationConsumablesCount == 0) {
            alert("請至少新增一筆借用設備");
            return false;
        }
        if (!document.getElementById("email").readOnly) {
            alert("請先驗證 Email 信箱");
            return false;
        }
        return true;
    }

    // ===== Email 驗證碼 =====
    function sendEmailVerificationCode() {
        var email = document.getElementById("email").value;
        if (!email) { alert("請輸入電子郵件地址"); return; }
        var regex = /^[a-zA-Z0-9._%+\-]+@@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;
        if (!regex.test(email)) { alert("請輸入正確的電子郵件地址"); return; }

        var code = "@Email_Verification_Code()";
        $.ajax({
            url: "@Url.Action("sendEmail_Verification_Code", "SendEmail_OverdueNotification")",
            type: "POST",
            data: { email: email, verification_code: code },
            success: function () {
                alert("已成功傳送驗證碼\n請檢查信箱（含垃圾郵件）");
                askForCode(code);
            },
            error: function () { alert("傳送失敗，請稍後再試"); }
        });
    }

    function askForCode(expected) {
        var entered = prompt("請輸入收到的驗證碼：");
        if (entered === null) return;
        if (entered.trim() === "") { alert("請輸入驗證碼"); askForCode(expected); return; }
        if (entered === expected) {
            var emailEl = document.getElementById("email");
            emailEl.readOnly = true;
            emailEl.classList.add("bg-light");
            document.getElementById("sendButton").style.display = "none";
            document.getElementById("emailVerifiedMsg").style.display = "block";
        } else {
            alert("驗證碼錯誤，請重新輸入");
            askForCode(expected);
        }
    }

    // ===== 消耗品數量 AJAX =====
    function changeValue(action, id, EName, Emodel, fOrderGuid) {
        var input = document.getElementById(id);
        var value = parseInt(input.value);
        $.get('@Url.Action("GetEquipmentQuantity", "BorrowEquipment1")', { EName: EName, Emodel: Emodel }, function (data) {
            var max = data.quantity;
            if (action === 'increase') {
                if (max === "∞" || value < parseInt(max)) {
                    value++; applicationConsumablesCount++;
                } else { alert('數量不能超過庫存量'); return; }
            } else if (action === 'decrease' && value > 1) {
                value--; applicationConsumablesCount--;
            }
            input.value = value;
            document.getElementById('consumables-count').textContent = applicationConsumablesCount;
            $.post('@Url.Action("UpdateConsumableBorrowingTimes", "BorrowEquipment1")',
                { EName: EName, Emodel: Emodel, newBorrowingTimes: value, fOrderGuid: fOrderGuid });
        });
    }

    // ===== 管理者模式 Modal =====
    function showAdminListModal() {
        document.getElementById('adminListPwd').value = '';
        document.getElementById('adminListError').classList.add('d-none');
        new bootstrap.Modal(document.getElementById('adminListModal')).show();
        setTimeout(function () { document.getElementById('adminListPwd').focus(); }, 300);
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('adminListPwd').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') validateAdminListPassword();
        });
    });

    function validateAdminListPassword() {
        var pwd = document.getElementById('adminListPwd').value;
        var btn = document.getElementById('adminListConfirmBtn');
        var err = document.getElementById('adminListError');
        if (!pwd) { err.textContent = '請輸入密碼'; err.classList.remove('d-none'); return; }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>驗證中';
        fetch('@Url.Action("ValidateAdminPassword", "Manager")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pwd })
        })
        .then(r => r.json())
        .then(function (data) {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('adminListModal')).hide();
                window.location.href = '@Url.Action("Manage_CreateApplicationCompleted_Application_List", "Manage_CreateApplicationCompleted")';
            } else {
                err.textContent = '密碼錯誤，請重新輸入';
                err.classList.remove('d-none');
                document.getElementById('adminListPwd').value = '';
                document.getElementById('adminListPwd').focus();
                btn.disabled = false;
                btn.innerHTML = '確認';
            }
        })
        .catch(function () {
            err.textContent = '驗證失敗，請稍後再試';
            err.classList.remove('d-none');
            btn.disabled = false;
            btn.innerHTML = '確認';
        });
    }
</script>
}
