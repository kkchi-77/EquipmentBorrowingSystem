@model Scaffoldong.ViewModel.Select_Equipment_BorrowingRecordsViewModel
@{
    ViewBag.Title = "查詢目前借用中設備";
    Layout = "~/Views/Shared/_Layout_Manager.cshtml";

    int countBorrowing = Model.Application_Completed.Count(m => m.Status == "Borrowing");
    int countOverdue   = Model.Application_Completed.Count(m => m.Status == "Overdue");
    int countReserved  = Model.Application_Completed.Count(m => m.Status == "Not_borrowed_yet");
    int countTotal     = Model.Application_Completed.Count();

    DateTime targetDate = new DateTime(2000, 10, 10);
    int itemcount = 0;
    bool isSearchResult = !string.IsNullOrEmpty(Model.IntputType) || !string.IsNullOrEmpty(Model.Borrow_Name);
}

@* ===== Stat Cards (僅在預設全覽時顯示) ===== *@
@if (!isSearchResult)
{
    <div class="row g-3 mb-4">
        <div class="col-6 col-xl-3">
            <div class="stat-card stat-success">
                <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
                <div>
                    <div class="stat-number">@countBorrowing</div>
                    <div class="stat-label">借用中</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-xl-3">
            <div class="stat-card stat-danger">
                <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                <div>
                    <div class="stat-number">@countOverdue</div>
                    <div class="stat-label">逾期未還</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-xl-3">
            <div class="stat-card stat-warning">
                <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                <div>
                    <div class="stat-number">@countReserved</div>
                    <div class="stat-label">已預約未借用</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-xl-3">
            <div class="stat-card stat-primary">
                <div class="stat-icon"><i class="bi bi-clipboard-data"></i></div>
                <div>
                    <div class="stat-number">@countTotal</div>
                    <div class="stat-label">合計筆數</div>
                </div>
            </div>
        </div>
    </div>
}

@* ===== Search Box ===== *@
<div class="search-box mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-12 col-md-auto">
            <label class="form-label fw-semibold small mb-1">查詢類別</label>
            <select id="DateType" name="DateType" class="form-select form-select-sm" onchange="showInputFields()" style="min-width:140px;">
                <option value="Borrower">借用人</option>
                <option value="ApplicationDate">申請日期</option>
                <option value="BorrowDate">借用日期</option>
                <option value="ReturnDate">歸還日期</option>
            </select>
        </div>

        <!-- 借用人搜尋 -->
        <div id="borrowerInputGroup" class="col-12 col-md-auto">
            <form id="borrowerForm" action="@Url.Action("ApplicationCompleted", "ApplicationCompleted")" method="post">
                <label class="form-label fw-semibold small mb-1">借用人姓名（關鍵字）</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="Borrow_Name" name="Borrow_Name" placeholder="請輸入關鍵字"
                           class="form-control" style="min-width:160px;" />
                    <button type="submit" onclick="return addSelectedBorrowType()" class="btn btn-accent">
                        <i class="bi bi-search"></i> 查詢
                    </button>
                </div>
            </form>
        </div>

        <!-- 日期範圍搜尋 -->
        <div id="dateRangeInputGroup" class="col-12 col-md-auto" style="display:none;">
            <form id="dateRangeForm" action="@Url.Action("ApplicationCompleted", "ApplicationCompleted")" method="post" onsubmit="return validateDates()">
                <label id="dateRangeLabel" class="form-label fw-semibold small mb-1">日期區間</label>
                <div class="input-group input-group-sm">
                    <input type="date" id="Date1" name="Date1" required class="form-control" />
                    <span class="input-group-text">～</span>
                    <input type="date" id="Date2" name="Date2" required class="form-control" />
                    <button type="submit" onclick="return addSelectedDateType()" class="btn btn-accent">
                        <i class="bi bi-search"></i> 查詢
                    </button>
                </div>
            </form>
        </div>

        <div class="col-12 col-md-auto">
            <label class="form-label fw-semibold small mb-1 d-block">&nbsp;</label>
            <a href="@Url.Action("ApplicationCompleted", "ApplicationCompleted")" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise me-1"></i>全部顯示
            </a>
        </div>
    </div>
</div>

@* ===== 搜尋結果說明 ===== *@
@if (isSearchResult)
{
    <div class="alert alert-light border d-flex align-items-center gap-2 py-2 mb-3">
        <i class="bi bi-info-circle text-primary"></i>
        <small>
            @if (Model.IntputType == "ApplicationDate")
            { <span>申請日期：@Model.Date1 ～ @Model.Date2，共 <strong>@countTotal</strong> 筆</span> }
            else if (Model.IntputType == "BorrowDate")
            { <span>借用日期：@Model.Date1 ～ @Model.Date2，共 <strong>@countTotal</strong> 筆</span> }
            else if (Model.IntputType == "ReturnDate")
            { <span>歸還日期：@Model.Date1 ～ @Model.Date2，共 <strong>@countTotal</strong> 筆</span> }
            else if (Model.IntputType == "Borrower")
            { <span>借用人關鍵字「@Model.Borrow_Name」，共 <strong>@countTotal</strong> 筆</span> }
        </small>
    </div>
}

@* ===== Main Table ===== *@
<div class="content-card">
    <div class="content-card-header">
        <h5><i class="bi bi-box-seam"></i> 目前借用中的設備</h5>
        @if (countOverdue > 0 && !isSearchResult)
        {
            <span class="badge bg-danger">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>@countOverdue 件逾期
            </span>
        }
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-custom mb-0">
            <thead>
                <tr>
                    <th style="width:4%">#</th>
                    <th style="width:18%">日期資訊</th>
                    <th style="width:9%">借用人</th>
                    <th style="width:16%">聯絡方式</th>
                    <th style="width:16%">用途／證件</th>
                    <th style="width:10%">移交人</th>
                    <th style="width:11%">狀態</th>
                    <th style="width:16%">操作</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Application_Completed.Any())
                {
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-4 d-block mb-1"></i>目前無借用中的設備
                        </td>
                    </tr>
                }
                @foreach (var item in Model.Application_Completed)
                {
                    itemcount++;
                    string rowClass = item.Status == "Overdue" ? "row-overdue" : "";
                    <tr class="@rowClass">
                        <td class="text-center">@itemcount</td>
                        <td>
                            @if (item.Date_Of_Application == targetDate)
                            {
                                <span class="badge bg-secondary mb-1">管理者申請</span><br />
                            }
                            else
                            {
                                <small class="text-muted">(申) @item.Date_Of_Application.ToString("yyyy/MM/dd")</small><br />
                            }
                            <small style="color:#1a7a33;"><i class="bi bi-box-arrow-up-right"></i> @item.Borrow_Time.ToString("yyyy/MM/dd")</small><br />
                            <small style="color:#c0392b;"><i class="bi bi-box-arrow-in-down-left"></i> @item.Return_Time.ToString("yyyy/MM/dd")</small>
                        </td>
                        <td class="fw-semibold">@item.Name</td>
                        <td>
                            <small><i class="bi bi-telephone me-1"></i>@item.Mobile</small><br />
                            <small class="text-muted"><i class="bi bi-envelope me-1"></i>@item.fEmail</small>
                        </td>
                        <td>
                            <small>@item.Illustrate</small>
                            @if (!string.IsNullOrWhiteSpace(item.Credentials_Mortgage))
                            {
                                <br /><small class="text-muted"><i class="bi bi-card-text me-1"></i>@item.Credentials_Mortgage</small>
                            }
                        </td>
                        <td><small>@item.Equipment_Handover_Person</small></td>
                        <td class="text-center">
                            @if (item.Status == "Borrowing")
                            {
                                <span class="status-badge badge-borrowing">
                                    <i class="bi bi-check-circle-fill"></i> 借用中
                                </span>
                            }
                            else if (item.Status == "Overdue")
                            {
                                <span class="status-badge badge-overdue">
                                    <i class="bi bi-exclamation-triangle-fill"></i> 逾期
                                </span>
                                @if (item.IsSendEmail == "True")
                                {
                                    <div class="mt-1">
                                        <form action="@Url.Action("Sendemail_OverdueNotification_Again", "ApplicationCompleted")" method="post">
                                            <input type="hidden" name="fOrderGuid" value="@item.fOrderGuid" />
                                            <button type="submit"
                                                    onclick="return confirm('確定要再次寄送逾期通知嗎?')"
                                                    class="btn btn-outline-danger btn-sm py-0 px-1"
                                                    style="font-size:.7rem;">
                                                <i class="bi bi-envelope-fill"></i> 再次通知
                                            </button>
                                        </form>
                                    </div>
                                }
                            }
                            else if (item.Status == "Not_borrowed_yet")
                            {
                                <span class="status-badge badge-reserved">
                                    <i class="bi bi-calendar-event"></i> 已預約
                                </span>
                            }
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <form action="@Url.Action("Select_ApplicationCompleted_List", "ApplicationCompleted")" method="post">
                                    <input type="hidden" name="fOrderGuid" value="@item.fOrderGuid" />
                                    <button type="submit" class="btn btn-sm btn-outline-primary w-100" style="font-size:.78rem;">
                                        <i class="bi bi-list-ul me-1"></i>詳細資訊
                                    </button>
                                </form>
                                <form action="@Url.Action("Equipment_Receive_Person", "EquipmentReturn")" method="post">
                                    <input type="hidden" name="fOrderGuid" value="@item.fOrderGuid" />
                                    <button type="submit" class="btn btn-sm btn-warning w-100" style="font-size:.78rem;">
                                        <i class="bi bi-box-arrow-in-down-left me-1"></i>設備歸還
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
<script>
    window.onload = function () { showInputFields(); };

    function showInputFields() {
        var v = document.getElementById("DateType").value;
        var borrowerGroup = document.getElementById("borrowerInputGroup");
        var dateGroup = document.getElementById("dateRangeInputGroup");
        var dateLabel = document.getElementById("dateRangeLabel");

        var labels = {
            ApplicationDate: "(申請日期)查詢區間",
            BorrowDate: "(借用日期)查詢區間",
            ReturnDate: "(歸還日期)查詢區間"
        };

        if (v === "Borrower") {
            borrowerGroup.style.display = "";
            dateGroup.style.display = "none";
        } else {
            borrowerGroup.style.display = "none";
            dateGroup.style.display = "";
            dateLabel.textContent = labels[v] || "日期區間";
        }
    }

    function addSelectedDateType() {
        var v = document.getElementById("DateType").value;
        var input = document.createElement("input");
        input.type = "hidden"; input.name = "IntputType"; input.value = v;
        document.getElementById("dateRangeForm").appendChild(input);
        return true;
    }

    function addSelectedBorrowType() {
        var v = document.getElementById("DateType").value;
        var input = document.createElement("input");
        input.type = "hidden"; input.name = "IntputType"; input.value = v;
        document.getElementById("borrowerForm").appendChild(input);
        return true;
    }

    function validateDates() {
        var d1 = document.getElementById("Date1").value;
        var d2 = document.getElementById("Date2").value;
        if (d1 > d2) { alert("結束日期不能早於開始日期"); return false; }
        return true;
    }
</script>
}
