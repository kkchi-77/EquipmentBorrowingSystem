name: Deploy to IIS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted   # 在 192.168.10.160 的 runner 上執行

    steps:
      - name: Checkout 程式碼
        uses: actions/checkout@v4

      - name: Restore 套件
        run: dotnet restore EquipmentBorrowingSystem/EquipmentBorrowingSystem.csproj

      - name: 發布專案
        run: |
          if (Test-Path "EquipmentBorrowingSystem\obj") { Remove-Item "EquipmentBorrowingSystem\obj" -Recurse -Force }
          if (Test-Path "EquipmentBorrowingSystem\bin") { Remove-Item "EquipmentBorrowingSystem\bin" -Recurse -Force }
          if (Test-Path "C:\deploy\EquipmentBorrowingSystem") { Remove-Item "C:\deploy\EquipmentBorrowingSystem" -Recurse -Force }
          dotnet publish EquipmentBorrowingSystem/EquipmentBorrowingSystem.csproj -c Release -o C:\deploy\EquipmentBorrowingSystem
        shell: powershell

      - name: 停止 IIS 網站
        run: |
          Import-Module WebAdministration
          Stop-WebSite -Name "EquipmentBorrowingSystem"
        shell: powershell

      - name: 複製檔案到 IIS 目錄
        run: |
          $src = "C:\deploy\EquipmentBorrowingSystem\*"
          $dst = "C:\inetpub\wwwroot\EquipmentBorrowingSystem"
          Copy-Item -Path $src -Destination $dst -Recurse -Force
        shell: powershell

      - name: 啟動 IIS 網站
        run: |
          Import-Module WebAdministration
          Start-WebSite -Name "EquipmentBorrowingSystem"
        shell: powershell

      - name: 部署完成通知
        run: echo "Deploy successful!"
